import os
from openai import OpenAI
import time
import random

client = OpenAI(
    base_url="https://router.huggingface.co/v1",
    api_key="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",
)

SYSTEM_PROMPT = """
You are a regular crypto enthusiast hanging out on Twitter, replying to posts from other crypto folks. 
Your replies must sound completely natural, as if written by a real person, NOT an AI. Don't put spaces after dots and commas
Keep your replies short and to the point ‚Äî 1 to 3 sentences, no overthinking or complicated words. Also you can ask reasonable questions.
Do NOT use emojis. Use crypto slang but not too much. If you use slang,use it only IN APPROPRIATE PLACES!!!
If you see some angry content that violates your rules, give simple answer, that barely connects to the tweet.
Avoid clich√©s, repeated phrases, or overly formal language ‚Äî each reply should feel fresh and unique. You even can make small grammar mistakes.
Don't use dashes or lots of spaces, and don't use quotes very often, if you can avoid them at all.Don't put space after comma.

The tone of your replies depends on the specified style:
- friendly ‚Äî warm, supportive, like talking to a crypto buddy,
- strict ‚Äî blunt, direct, no sugarcoating,
- ironic ‚Äî sarcastic and teasing, but not mean-spirited.

The main goal is for your replies to sound exactly like real crypto community members commenting on Twitter, not like something generated by a bot.
"""

def generate_reply(tweet_text: str, settings: dict, **extra):
    """
    –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ –Ω–∞ —Ç–≤–∏—Ç —Å –≥–∞—Ä–∞–Ω—Ç–∏–µ–π –ø–æ–ª–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
    :param tweet_text: —Ç–µ–∫—Å—Ç —Ç–≤–∏—Ç–∞
    :param settings: —Å–ª–æ–≤–∞—Ä—å —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ (tone, min_reply_delay, max_reply_delay)
    :param extra: model, temperature, max_tokens –∏ –¥—Ä.
    :return: dict { "tweet": ..., "reply": ..., "tone": ..., "model": ... }
    """
    tone = settings.get("tone", "friendly")
    model = extra.get("model", "openai/gpt-oss-120b:cerebras")
    temperature = extra.get("temperature", 0.8)
    max_tokens = extra.get("max_tokens", 400)  # —É–≤–µ–ª–∏—á–µ–Ω–æ –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
    retries = 5
    full_reply = ""

    messages = [
        {"role": "system", "content": SYSTEM_PROMPT},
        {"role": "assistant", "content": f"–¢–æ–Ω –æ–±—â–µ–Ω–∏—è: {tone}"},
        {"role": "user", "content": f"–¢–≤–∏—Ç: {tweet_text}"},
    ]

    for attempt in range(1, retries + 1):
        try:
            response = client.chat.completions.create(
                model=model,
                messages=messages,
                max_tokens=max_tokens,
                temperature=temperature,
            )
            choice = response.choices[0]
            content = getattr(choice.message, "content", "")
            finish_reason = getattr(choice, "finish_reason", "stop")

            if content:
                full_reply += content.strip()

            if finish_reason == "stop" and full_reply:
                break  # –æ—Ç–≤–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω
            else:
                wait_time = random.uniform(5, 10) * attempt
                print(f"‚ö†Ô∏è –ü–æ–ø—ã—Ç–∫–∞ {attempt} –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ (finish_reason={finish_reason}), –ø–æ–≤—Ç–æ—Ä —á–µ—Ä–µ–∑ {wait_time:.1f} —Å–µ–∫...")
                time.sleep(wait_time)
        except Exception as e:
            wait_time = random.uniform(5, 10) * attempt
            print(f"‚ùå –ü–æ–ø—ã—Ç–∫–∞ {attempt} –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å –æ—à–∏–±–∫–æ–π: {e}, –ø–æ–≤—Ç–æ—Ä —á–µ—Ä–µ–∑ {wait_time:.1f} —Å–µ–∫...")
            time.sleep(wait_time)

    # fallback –Ω–∞ –∫–æ—Ä–æ—Ç–∫–∏–π –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –æ—Ç–≤–µ—Ç
    if not full_reply or len(full_reply.strip()) < 15:
        full_reply = "OK your are strange kinda"

    return {"tweet": tweet_text, "reply": full_reply.strip(), "tone": tone, "model": model}


# –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
if __name__ == "__main__":
    tweet = "Lost a lot of money this month, tell me your ways to pass this bad time, your methods to overcome this"
    settings = {"tone": "friendly", "min_reply_delay": 10, "max_reply_delay": 120}

    result = generate_reply(tweet, settings)
    print("üìå –¢–≤–∏—Ç:", result["tweet"])
    print("üí¨ –û—Ç–≤–µ—Ç:", result["reply"])
